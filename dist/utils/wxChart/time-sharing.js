'use strict';

/**
 * Created by ChenChao on 2016/12/30.
 */

var common = require('./common.js');
var _axis = require('./axis-t.js')();

module.exports = function (canvasId) {
  return {
    name: '',
    unit: 240,
    canvasId: canvasId,
    ctx: null,
    canvasWidth: 0,
    canvasHeight: 0,
    paddingTop: 0,
    paddingBottom: 0,
    paddingLeft: 0,
    paddingRight: 0,
    options: null,
    dataStore: null,
    index: 0,
    base: 0,
    maxAbs: 0,
    txtColor: 'white',
    isClosed: false,
    axisObj: null,
    init: function init(options) {
      this.ctx = wx.createCanvasContext(this.canvasId);
      this.initConfig(options);
      return this;
    },

    initConfig: function initConfig(options) {
      var that = this;
      var axis = options.axis;
      this.name = options.name;
      if (options.name == 'time-sharing-5day') {
        this.unit = this.unit * 5;
      }
      var w = options.width;
      var h = options.height;
      if (w === 'auto') {
        wx.getSystemInfo({
          success: function success(result) {
            w = that.canvasWidth = result.windowWidth;
          }
        });
      }
      if (h === 'auto') {
        h = 225;
      }
      this.canvasWidth = w;
      this.canvasHeight = h;
      options.xAxis.data.length = this.unit;
      this.paddingTop = axis.paddingTop;
      this.paddingBottom = axis.paddingBottom;
      this.paddingLeft = axis.paddingLeft;
      this.paddingRight = axis.paddingRight;
      this.dataStore = options;
    },

    metaData1: function metaData1(origin, options) {
      var dataStore = options;
      var data = origin.data;
      var xAxis = dataStore.xAxis;

      var yAxis = dataStore.yAxis;
      var base = origin.info.yc * 1;
      var h = origin.info.h * 1 || base;
      var l = origin.info.l * 1 || base;
      var maxAbs = h ? Math.max(Math.abs(h - base), Math.abs(l - base)) : this.maxAbs;

      // 停盘
      if (origin.info.c == '-') {
        this.isClosed = true;
        yAxis[1].isAverageLine = true;
      }

      var data0 = yAxis[1].data;
      yAxis[0].base = base; // 昨收
      var data1 = yAxis[0].data;
      // if(data.length < 15){
      //     data = []
      // }else if(data.length < 15 + this.unit){
      //     data = data.slice(15); //去掉前15条数据
      // }else{
      //     data = data.slice(data.length - this.unit - 1); //去掉前15条数据
      // }
      var day5 = [];
      data.forEach(function (item, index) {
        var d = item.split(',');
        xAxis.data[index] = d[0]; // 时间
        data0[index] = d[3]; // 均价
        data1[index] = d[1]; // 现价
        maxAbs = Math.max(Math.abs(d[1] - base), Math.abs(d[3] - base), maxAbs);
        // yAxis[0].maxAbs = yAxis[1].maxAbs = maxAbs;
      });
      this.base = base;
      this.maxAbs = yAxis[0].maxAbs = yAxis[1].maxAbs = maxAbs;
      dataStore.axis.day5 = common.disRepArr(day5);
      this.setOptions(dataStore);
    },

    metaData2: function metaData2(origin, options) {
      var dataStore = options;
      var data = origin.data;

      // 停盘
      if (origin.info.c == '-') {
        this.isClosed = true;
      }

      var xAxis = dataStore.xAxis;
      var yAxis = dataStore.yAxis;
      var data0 = yAxis[0].data;
      var dd = [];
      var color0 = yAxis[0].color;
      //       if (data.length < 15) {
      //   data = []
      // } else if (data.length < 15 + this.unit) {
      //   data = data.slice(15) //去掉前15条数据
      //       } else{
      //   data = data.slice(data.length - this.unit - 1) //去掉前15条数据
      //       }
      var day5 = [];
      data.forEach(function (item, index) {
        var d = item.split(',');
        xAxis.data[index] = d[0]; // 时间
        data0[index] = d[2]; // 成交量
        dd[index] = d[1]; // 现价
        color0[index] = dd[index] - dd[index - 1] < 0 ? '#4cda64' : '#ff2f2f';
        day5.push(d[0].split(' ')[0]);
      });
      dataStore.axis.day5 = common.disRepArr(day5);
      this.setOptions(dataStore);
    },

    setOptions: function setOptions(options) {
      this.options = options;
    },

    axis: function axis(ctx, options) {
      this.axisObj = _axis.init(ctx, options);
    },

    line: function line(option) {
      if (this.isClosed && !option.isAverageLine) {
        return;
      }
      var that = this;
      var ctx = this.ctx;
      var canvasHeight = this.canvasHeight;
      var canvasWidth = this.canvasWidth;
      var step = (canvasWidth - this.paddingLeft - this.paddingRight) / this.unit;
      var areaH = canvasHeight - this.paddingTop - this.paddingBottom;
      var max = this.base + this.maxAbs;
      var min = this.base - this.maxAbs;
      var data = [];
      option.xAxis.data.map(function (item, index) {
        var d = option.data[index];
        var value = areaH - areaH * (d - min) / (max - min);
        data.push([index * step - that.paddingLeft, value - that.paddingBottom]);
      });

      if (option.isAverageLine) {
        ctx.translate(0, canvasHeight / 2);
      }

      // 填充
      ctx.beginPath();
      ctx.moveTo(this.paddingLeft, this.canvasHeight - this.paddingBottom);
      var lastX = 0;
      data.map(function (item, index) {
        ctx.lineTo(item[0], item[1]);
        lastX = item[0];
      });
      ctx.lineTo(lastX, this.canvasHeight - this.paddingBottom);
      ctx.closePath();
      if (typeof option.background === 'function') {
        var colorStop = option.background();
        var grd = ctx.createLinearGradient(0, 0, 0, canvasHeight);
        grd.addColorStop(0, colorStop[0]);
        grd.addColorStop(1, colorStop[1]);
        ctx.setFillStyle(grd);
        ctx.fill();
      }
      if (typeof option.background === 'string') {
        ctx.setFillStyle(option.background);
        ctx.fill();
      }
      ctx.setLineWidth(1);
      ctx.setLineCap('square');
      ctx.setStrokeStyle('rgba(0,0,0,0)');
      ctx.stroke();

      // 均线
      ctx.beginPath();
      data.map(function (item, index) {
        ctx[index === 0 ? 'moveTo' : 'lineTo'](item[0], item[1]);
      });
      ctx.setLineWidth(1);
      ctx.setLineCap('square');
      ctx.setStrokeStyle(option.lineColor);
      ctx.stroke();

      if (option.isAverageLine) {
        ctx.translate(0, -canvasHeight / 2);
      }
    },
    bezierLine: function bezierLine(option) {
      if (this.isClosed) {
        return;
      }
      common.bezierLine.call(this, option);
    },
    bar: function bar(option) {
      if (this.isClosed) {
        return;
      }
      var startTime = +new Date();
      var data = option.data;
      var ctx = this.ctx;
      var canvasHeight = this.canvasHeight;
      var canvasWidth = this.canvasWidth;
      var pb = this.paddingBottom;
      var barW = (canvasWidth - this.paddingLeft - this.paddingRight) / this.unit;
      var max = data.length === 0 ? 0 : Math.max.apply(null, data) * 1;
      var step = max == 0 ? 0 : (canvasHeight - this.paddingTop - pb) / max;
      data.map(function (item, index) {
        var barH = item * step;
        ctx.beginPath();
        ctx.setLineWidth(barW);
        ctx.moveTo(index * barW + 1, canvasHeight - pb);
        ctx.lineTo(index * barW + 1, canvasHeight - pb - barH);
        ctx.setStrokeStyle(option.color[index]);
        ctx.stroke();
      });
      if (option.complete) {
        option.complete(+new Date() - startTime);
      }
      if (option.showMax) {
        ctx.setFillStyle(this.txtColor);
        ctx.fillText(common.metaUnit(max), this.paddingLeft + 2, this.paddingTop + 12);
      }
    },
    draw: function draw() {
      var that = this;
      var ctx = this.ctx;
      var options = this.options;
      if (!options) {
        console.log('Warn: No setting options!');
        return;
      }
      var xAxis = options.xAxis;
      var startTime = +new Date();
      this.axis(ctx, options);
      options.yAxis.map(function (option, index) {
        option.xAxis = xAxis;
        that[option.type](option);
      });
      this.axisObj.drawYUnit();
      ctx.draw();
      options.callback && options.callback(+new Date() - startTime);
    }
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRpbWUtc2hhcmluZy5qcyJdLCJuYW1lcyI6WyJjb21tb24iLCJyZXF1aXJlIiwiYXhpcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJjYW52YXNJZCIsIm5hbWUiLCJ1bml0IiwiY3R4IiwiY2FudmFzV2lkdGgiLCJjYW52YXNIZWlnaHQiLCJwYWRkaW5nVG9wIiwicGFkZGluZ0JvdHRvbSIsInBhZGRpbmdMZWZ0IiwicGFkZGluZ1JpZ2h0Iiwib3B0aW9ucyIsImRhdGFTdG9yZSIsImluZGV4IiwiYmFzZSIsIm1heEFicyIsInR4dENvbG9yIiwiaXNDbG9zZWQiLCJheGlzT2JqIiwiaW5pdCIsInd4IiwiY3JlYXRlQ2FudmFzQ29udGV4dCIsImluaXRDb25maWciLCJ0aGF0IiwidyIsIndpZHRoIiwiaCIsImhlaWdodCIsImdldFN5c3RlbUluZm8iLCJzdWNjZXNzIiwicmVzdWx0Iiwid2luZG93V2lkdGgiLCJ4QXhpcyIsImRhdGEiLCJsZW5ndGgiLCJtZXRhRGF0YTEiLCJvcmlnaW4iLCJ5QXhpcyIsImluZm8iLCJ5YyIsImwiLCJNYXRoIiwibWF4IiwiYWJzIiwiYyIsImlzQXZlcmFnZUxpbmUiLCJkYXRhMCIsImRhdGExIiwiZGF5NSIsImZvckVhY2giLCJpdGVtIiwiZCIsInNwbGl0IiwiZGlzUmVwQXJyIiwic2V0T3B0aW9ucyIsIm1ldGFEYXRhMiIsImRkIiwiY29sb3IwIiwiY29sb3IiLCJwdXNoIiwibGluZSIsIm9wdGlvbiIsInN0ZXAiLCJhcmVhSCIsIm1pbiIsIm1hcCIsInZhbHVlIiwidHJhbnNsYXRlIiwiYmVnaW5QYXRoIiwibW92ZVRvIiwibGFzdFgiLCJsaW5lVG8iLCJjbG9zZVBhdGgiLCJiYWNrZ3JvdW5kIiwiY29sb3JTdG9wIiwiZ3JkIiwiY3JlYXRlTGluZWFyR3JhZGllbnQiLCJhZGRDb2xvclN0b3AiLCJzZXRGaWxsU3R5bGUiLCJmaWxsIiwic2V0TGluZVdpZHRoIiwic2V0TGluZUNhcCIsInNldFN0cm9rZVN0eWxlIiwic3Ryb2tlIiwibGluZUNvbG9yIiwiYmV6aWVyTGluZSIsImNhbGwiLCJiYXIiLCJzdGFydFRpbWUiLCJEYXRlIiwicGIiLCJiYXJXIiwiYXBwbHkiLCJiYXJIIiwiY29tcGxldGUiLCJzaG93TWF4IiwiZmlsbFRleHQiLCJtZXRhVW5pdCIsImRyYXciLCJjb25zb2xlIiwibG9nIiwidHlwZSIsImRyYXdZVW5pdCIsImNhbGxiYWNrIl0sIm1hcHBpbmdzIjoiOztBQUFBOzs7O0FBSUEsSUFBSUEsU0FBU0MsUUFBUSxVQUFSLENBQWI7QUFDQSxJQUFJQyxRQUFPRCxRQUFRLFVBQVIsR0FBWDs7QUFFQUUsT0FBT0MsT0FBUCxHQUFpQixVQUFVQyxRQUFWLEVBQW9CO0FBQ25DLFNBQU87QUFDTEMsVUFBTSxFQUREO0FBRUxDLFVBQU0sR0FGRDtBQUdMRixjQUFVQSxRQUhMO0FBSUxHLFNBQUssSUFKQTtBQUtMQyxpQkFBYSxDQUxSO0FBTUxDLGtCQUFjLENBTlQ7QUFPTEMsZ0JBQVksQ0FQUDtBQVFMQyxtQkFBZSxDQVJWO0FBU0xDLGlCQUFhLENBVFI7QUFVTEMsa0JBQWMsQ0FWVDtBQVdMQyxhQUFTLElBWEo7QUFZTEMsZUFBVyxJQVpOO0FBYUxDLFdBQU8sQ0FiRjtBQWNMQyxVQUFNLENBZEQ7QUFlTEMsWUFBUSxDQWZIO0FBZ0JMQyxjQUFVLE9BaEJMO0FBaUJMQyxjQUFVLEtBakJMO0FBa0JMQyxhQUFTLElBbEJKO0FBbUJMQyxVQUFNLGNBQVVSLE9BQVYsRUFBbUI7QUFDdkIsV0FBS1AsR0FBTCxHQUFXZ0IsR0FBR0MsbUJBQUgsQ0FBdUIsS0FBS3BCLFFBQTVCLENBQVg7QUFDQSxXQUFLcUIsVUFBTCxDQUFnQlgsT0FBaEI7QUFDQSxhQUFPLElBQVA7QUFDRCxLQXZCSTs7QUF5QkxXLGdCQUFZLG9CQUFVWCxPQUFWLEVBQW1CO0FBQzdCLFVBQUlZLE9BQU8sSUFBWDtBQUNBLFVBQUl6QixPQUFPYSxRQUFRYixJQUFuQjtBQUNBLFdBQUtJLElBQUwsR0FBWVMsUUFBUVQsSUFBcEI7QUFDQSxVQUFJUyxRQUFRVCxJQUFSLElBQWdCLG1CQUFwQixFQUF5QztBQUN2QyxhQUFLQyxJQUFMLEdBQVksS0FBS0EsSUFBTCxHQUFZLENBQXhCO0FBQ0Q7QUFDRCxVQUFJcUIsSUFBSWIsUUFBUWMsS0FBaEI7QUFDQSxVQUFJQyxJQUFJZixRQUFRZ0IsTUFBaEI7QUFDQSxVQUFJSCxNQUFNLE1BQVYsRUFBa0I7QUFDaEJKLFdBQUdRLGFBQUgsQ0FBaUI7QUFDZkMsbUJBQVMsaUJBQVVDLE1BQVYsRUFBa0I7QUFDekJOLGdCQUFJRCxLQUFLbEIsV0FBTCxHQUFtQnlCLE9BQU9DLFdBQTlCO0FBQ0Q7QUFIYyxTQUFqQjtBQUtEO0FBQ0QsVUFBSUwsTUFBTSxNQUFWLEVBQWtCO0FBQ2hCQSxZQUFJLEdBQUo7QUFDRDtBQUNELFdBQUtyQixXQUFMLEdBQW1CbUIsQ0FBbkI7QUFDQSxXQUFLbEIsWUFBTCxHQUFvQm9CLENBQXBCO0FBQ0FmLGNBQVFxQixLQUFSLENBQWNDLElBQWQsQ0FBbUJDLE1BQW5CLEdBQTRCLEtBQUsvQixJQUFqQztBQUNBLFdBQUtJLFVBQUwsR0FBa0JULEtBQUtTLFVBQXZCO0FBQ0EsV0FBS0MsYUFBTCxHQUFxQlYsS0FBS1UsYUFBMUI7QUFDQSxXQUFLQyxXQUFMLEdBQW1CWCxLQUFLVyxXQUF4QjtBQUNBLFdBQUtDLFlBQUwsR0FBb0JaLEtBQUtZLFlBQXpCO0FBQ0EsV0FBS0UsU0FBTCxHQUFpQkQsT0FBakI7QUFDRCxLQXBESTs7QUFzREx3QixlQUFXLG1CQUFVQyxNQUFWLEVBQWtCekIsT0FBbEIsRUFBMkI7QUFDcEMsVUFBSUMsWUFBWUQsT0FBaEI7QUFDQSxVQUFJc0IsT0FBT0csT0FBT0gsSUFBbEI7QUFDQSxVQUFJRCxRQUFRcEIsVUFBVW9CLEtBQXRCOztBQUVBLFVBQUlLLFFBQVF6QixVQUFVeUIsS0FBdEI7QUFDQSxVQUFJdkIsT0FBT3NCLE9BQU9FLElBQVAsQ0FBWUMsRUFBWixHQUFpQixDQUE1QjtBQUNBLFVBQUliLElBQUlVLE9BQU9FLElBQVAsQ0FBWVosQ0FBWixHQUFnQixDQUFoQixJQUFxQlosSUFBN0I7QUFDQSxVQUFJMEIsSUFBSUosT0FBT0UsSUFBUCxDQUFZRSxDQUFaLEdBQWdCLENBQWhCLElBQXFCMUIsSUFBN0I7QUFDQSxVQUFJQyxTQUFTVyxJQUFJZSxLQUFLQyxHQUFMLENBQVNELEtBQUtFLEdBQUwsQ0FBU2pCLElBQUlaLElBQWIsQ0FBVCxFQUE2QjJCLEtBQUtFLEdBQUwsQ0FBU0gsSUFBSTFCLElBQWIsQ0FBN0IsQ0FBSixHQUF1RCxLQUFLQyxNQUF6RTs7QUFFQTtBQUNBLFVBQUlxQixPQUFPRSxJQUFQLENBQVlNLENBQVosSUFBaUIsR0FBckIsRUFBMEI7QUFDeEIsYUFBSzNCLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQW9CLGNBQU0sQ0FBTixFQUFTUSxhQUFULEdBQXlCLElBQXpCO0FBQ0Q7O0FBRUQsVUFBSUMsUUFBUVQsTUFBTSxDQUFOLEVBQVNKLElBQXJCO0FBQ0FJLFlBQU0sQ0FBTixFQUFTdkIsSUFBVCxHQUFnQkEsSUFBaEIsQ0FsQm9DLENBa0JmO0FBQ3JCLFVBQUlpQyxRQUFRVixNQUFNLENBQU4sRUFBU0osSUFBckI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQUllLE9BQU8sRUFBWDtBQUNBZixXQUFLZ0IsT0FBTCxDQUFhLFVBQVVDLElBQVYsRUFBZ0JyQyxLQUFoQixFQUF1QjtBQUNsQyxZQUFJc0MsSUFBSUQsS0FBS0UsS0FBTCxDQUFXLEdBQVgsQ0FBUjtBQUNBcEIsY0FBTUMsSUFBTixDQUFXcEIsS0FBWCxJQUFvQnNDLEVBQUUsQ0FBRixDQUFwQixDQUZrQyxDQUVUO0FBQ3pCTCxjQUFNakMsS0FBTixJQUFlc0MsRUFBRSxDQUFGLENBQWYsQ0FIa0MsQ0FHZDtBQUNwQkosY0FBTWxDLEtBQU4sSUFBZXNDLEVBQUUsQ0FBRixDQUFmLENBSmtDLENBSWQ7QUFDcEJwQyxpQkFBUzBCLEtBQUtDLEdBQUwsQ0FBU0QsS0FBS0UsR0FBTCxDQUFTUSxFQUFFLENBQUYsSUFBT3JDLElBQWhCLENBQVQsRUFBZ0MyQixLQUFLRSxHQUFMLENBQVNRLEVBQUUsQ0FBRixJQUFPckMsSUFBaEIsQ0FBaEMsRUFBdURDLE1BQXZELENBQVQ7QUFDQTtBQUNELE9BUEQ7QUFRQSxXQUFLRCxJQUFMLEdBQVlBLElBQVo7QUFDQSxXQUFLQyxNQUFMLEdBQWNzQixNQUFNLENBQU4sRUFBU3RCLE1BQVQsR0FBa0JzQixNQUFNLENBQU4sRUFBU3RCLE1BQVQsR0FBa0JBLE1BQWxEO0FBQ0FILGdCQUFVZCxJQUFWLENBQWVrRCxJQUFmLEdBQXNCcEQsT0FBT3lELFNBQVAsQ0FBaUJMLElBQWpCLENBQXRCO0FBQ0EsV0FBS00sVUFBTCxDQUFnQjFDLFNBQWhCO0FBQ0QsS0E5Rkk7O0FBZ0dMMkMsZUFBVyxtQkFBVW5CLE1BQVYsRUFBa0J6QixPQUFsQixFQUEyQjtBQUNwQyxVQUFJQyxZQUFZRCxPQUFoQjtBQUNBLFVBQUlzQixPQUFPRyxPQUFPSCxJQUFsQjs7QUFFQTtBQUNBLFVBQUlHLE9BQU9FLElBQVAsQ0FBWU0sQ0FBWixJQUFpQixHQUFyQixFQUEwQjtBQUN4QixhQUFLM0IsUUFBTCxHQUFnQixJQUFoQjtBQUNEOztBQUVELFVBQUllLFFBQVFwQixVQUFVb0IsS0FBdEI7QUFDQSxVQUFJSyxRQUFRekIsVUFBVXlCLEtBQXRCO0FBQ0EsVUFBSVMsUUFBUVQsTUFBTSxDQUFOLEVBQVNKLElBQXJCO0FBQ0EsVUFBSXVCLEtBQUssRUFBVDtBQUNBLFVBQUlDLFNBQVNwQixNQUFNLENBQU4sRUFBU3FCLEtBQXRCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFJVixPQUFPLEVBQVg7QUFDQWYsV0FBS2dCLE9BQUwsQ0FBYSxVQUFVQyxJQUFWLEVBQWdCckMsS0FBaEIsRUFBdUI7QUFDbEMsWUFBSXNDLElBQUlELEtBQUtFLEtBQUwsQ0FBVyxHQUFYLENBQVI7QUFDQXBCLGNBQU1DLElBQU4sQ0FBV3BCLEtBQVgsSUFBb0JzQyxFQUFFLENBQUYsQ0FBcEIsQ0FGa0MsQ0FFVDtBQUN6QkwsY0FBTWpDLEtBQU4sSUFBZXNDLEVBQUUsQ0FBRixDQUFmLENBSGtDLENBR2Q7QUFDcEJLLFdBQUczQyxLQUFILElBQVlzQyxFQUFFLENBQUYsQ0FBWixDQUprQyxDQUlqQjtBQUNqQk0sZUFBTzVDLEtBQVAsSUFBZ0IyQyxHQUFHM0MsS0FBSCxJQUFZMkMsR0FBRzNDLFFBQVEsQ0FBWCxDQUFaLEdBQTRCLENBQTVCLEdBQWdDLFNBQWhDLEdBQTRDLFNBQTVEO0FBQ0FtQyxhQUFLVyxJQUFMLENBQVVSLEVBQUUsQ0FBRixFQUFLQyxLQUFMLENBQVcsR0FBWCxFQUFnQixDQUFoQixDQUFWO0FBQ0QsT0FQRDtBQVFBeEMsZ0JBQVVkLElBQVYsQ0FBZWtELElBQWYsR0FBc0JwRCxPQUFPeUQsU0FBUCxDQUFpQkwsSUFBakIsQ0FBdEI7QUFDQSxXQUFLTSxVQUFMLENBQWdCMUMsU0FBaEI7QUFDRCxLQWhJSTs7QUFrSUwwQyxnQkFBWSxvQkFBVTNDLE9BQVYsRUFBbUI7QUFDN0IsV0FBS0EsT0FBTCxHQUFlQSxPQUFmO0FBQ0QsS0FwSUk7O0FBc0lMYixVQUFNLGNBQVVNLEdBQVYsRUFBZU8sT0FBZixFQUF3QjtBQUM1QixXQUFLTyxPQUFMLEdBQWVwQixNQUFLcUIsSUFBTCxDQUFVZixHQUFWLEVBQWVPLE9BQWYsQ0FBZjtBQUNELEtBeElJOztBQTBJTGlELFVBQU0sY0FBVUMsTUFBVixFQUFrQjtBQUN0QixVQUFJLEtBQUs1QyxRQUFMLElBQWlCLENBQUM0QyxPQUFPaEIsYUFBN0IsRUFBNEM7QUFDMUM7QUFDRDtBQUNELFVBQUl0QixPQUFPLElBQVg7QUFDQSxVQUFJbkIsTUFBTSxLQUFLQSxHQUFmO0FBQ0EsVUFBSUUsZUFBZSxLQUFLQSxZQUF4QjtBQUNBLFVBQUlELGNBQWMsS0FBS0EsV0FBdkI7QUFDQSxVQUFJeUQsT0FBTyxDQUFDekQsY0FBYyxLQUFLSSxXQUFuQixHQUFpQyxLQUFLQyxZQUF2QyxJQUF1RCxLQUFLUCxJQUF2RTtBQUNBLFVBQUk0RCxRQUFRekQsZUFBZSxLQUFLQyxVQUFwQixHQUFpQyxLQUFLQyxhQUFsRDtBQUNBLFVBQUlrQyxNQUFNLEtBQUs1QixJQUFMLEdBQVksS0FBS0MsTUFBM0I7QUFDQSxVQUFJaUQsTUFBTSxLQUFLbEQsSUFBTCxHQUFZLEtBQUtDLE1BQTNCO0FBQ0EsVUFBSWtCLE9BQU8sRUFBWDtBQUNBNEIsYUFBTzdCLEtBQVAsQ0FBYUMsSUFBYixDQUFrQmdDLEdBQWxCLENBQXNCLFVBQVVmLElBQVYsRUFBZ0JyQyxLQUFoQixFQUF1QjtBQUMzQyxZQUFJc0MsSUFBSVUsT0FBTzVCLElBQVAsQ0FBWXBCLEtBQVosQ0FBUjtBQUNBLFlBQUlxRCxRQUFRSCxRQUFRQSxTQUFTWixJQUFJYSxHQUFiLEtBQXFCdEIsTUFBTXNCLEdBQTNCLENBQXBCO0FBQ0EvQixhQUFLMEIsSUFBTCxDQUFVLENBQUM5QyxRQUFRaUQsSUFBUixHQUFldkMsS0FBS2QsV0FBckIsRUFBa0N5RCxRQUFRM0MsS0FBS2YsYUFBL0MsQ0FBVjtBQUNELE9BSkQ7O0FBTUEsVUFBSXFELE9BQU9oQixhQUFYLEVBQTBCO0FBQ3hCekMsWUFBSStELFNBQUosQ0FBYyxDQUFkLEVBQWlCN0QsZUFBZSxDQUFoQztBQUNEOztBQUVEO0FBQ0FGLFVBQUlnRSxTQUFKO0FBQ0FoRSxVQUFJaUUsTUFBSixDQUFXLEtBQUs1RCxXQUFoQixFQUE2QixLQUFLSCxZQUFMLEdBQW9CLEtBQUtFLGFBQXREO0FBQ0EsVUFBSThELFFBQVEsQ0FBWjtBQUNBckMsV0FBS2dDLEdBQUwsQ0FBUyxVQUFVZixJQUFWLEVBQWdCckMsS0FBaEIsRUFBdUI7QUFDOUJULFlBQUltRSxNQUFKLENBQVdyQixLQUFLLENBQUwsQ0FBWCxFQUFvQkEsS0FBSyxDQUFMLENBQXBCO0FBQ0FvQixnQkFBUXBCLEtBQUssQ0FBTCxDQUFSO0FBQ0QsT0FIRDtBQUlBOUMsVUFBSW1FLE1BQUosQ0FBV0QsS0FBWCxFQUFrQixLQUFLaEUsWUFBTCxHQUFvQixLQUFLRSxhQUEzQztBQUNBSixVQUFJb0UsU0FBSjtBQUNBLFVBQUksT0FBT1gsT0FBT1ksVUFBZCxLQUE2QixVQUFqQyxFQUE2QztBQUMzQyxZQUFJQyxZQUFZYixPQUFPWSxVQUFQLEVBQWhCO0FBQ0EsWUFBSUUsTUFBTXZFLElBQUl3RSxvQkFBSixDQUF5QixDQUF6QixFQUE0QixDQUE1QixFQUErQixDQUEvQixFQUFrQ3RFLFlBQWxDLENBQVY7QUFDQXFFLFlBQUlFLFlBQUosQ0FBaUIsQ0FBakIsRUFBb0JILFVBQVUsQ0FBVixDQUFwQjtBQUNBQyxZQUFJRSxZQUFKLENBQWlCLENBQWpCLEVBQW9CSCxVQUFVLENBQVYsQ0FBcEI7QUFDQXRFLFlBQUkwRSxZQUFKLENBQWlCSCxHQUFqQjtBQUNBdkUsWUFBSTJFLElBQUo7QUFDRDtBQUNELFVBQUksT0FBT2xCLE9BQU9ZLFVBQWQsS0FBNkIsUUFBakMsRUFBMkM7QUFDekNyRSxZQUFJMEUsWUFBSixDQUFpQmpCLE9BQU9ZLFVBQXhCO0FBQ0FyRSxZQUFJMkUsSUFBSjtBQUNEO0FBQ0QzRSxVQUFJNEUsWUFBSixDQUFpQixDQUFqQjtBQUNBNUUsVUFBSTZFLFVBQUosQ0FBZSxRQUFmO0FBQ0E3RSxVQUFJOEUsY0FBSixDQUFtQixlQUFuQjtBQUNBOUUsVUFBSStFLE1BQUo7O0FBRUE7QUFDQS9FLFVBQUlnRSxTQUFKO0FBQ0FuQyxXQUFLZ0MsR0FBTCxDQUFTLFVBQVVmLElBQVYsRUFBZ0JyQyxLQUFoQixFQUF1QjtBQUM5QlQsWUFBSVMsVUFBVSxDQUFWLEdBQWMsUUFBZCxHQUF5QixRQUE3QixFQUF1Q3FDLEtBQUssQ0FBTCxDQUF2QyxFQUFnREEsS0FBSyxDQUFMLENBQWhEO0FBQ0QsT0FGRDtBQUdBOUMsVUFBSTRFLFlBQUosQ0FBaUIsQ0FBakI7QUFDQTVFLFVBQUk2RSxVQUFKLENBQWUsUUFBZjtBQUNBN0UsVUFBSThFLGNBQUosQ0FBbUJyQixPQUFPdUIsU0FBMUI7QUFDQWhGLFVBQUkrRSxNQUFKOztBQUVBLFVBQUl0QixPQUFPaEIsYUFBWCxFQUEwQjtBQUN4QnpDLFlBQUkrRCxTQUFKLENBQWMsQ0FBZCxFQUFpQixDQUFDN0QsWUFBRCxHQUFnQixDQUFqQztBQUNEO0FBQ0YsS0F6TUk7QUEwTUwrRSxnQkFBWSxvQkFBVXhCLE1BQVYsRUFBa0I7QUFDNUIsVUFBSSxLQUFLNUMsUUFBVCxFQUFtQjtBQUNqQjtBQUNEO0FBQ0RyQixhQUFPeUYsVUFBUCxDQUFrQkMsSUFBbEIsQ0FBdUIsSUFBdkIsRUFBNkJ6QixNQUE3QjtBQUNELEtBL01JO0FBZ05MMEIsU0FBSyxhQUFVMUIsTUFBVixFQUFrQjtBQUNyQixVQUFJLEtBQUs1QyxRQUFULEVBQW1CO0FBQ2pCO0FBQ0Q7QUFDRCxVQUFJdUUsWUFBWSxDQUFDLElBQUlDLElBQUosRUFBakI7QUFDQSxVQUFJeEQsT0FBTzRCLE9BQU81QixJQUFsQjtBQUNBLFVBQUk3QixNQUFNLEtBQUtBLEdBQWY7QUFDQSxVQUFJRSxlQUFlLEtBQUtBLFlBQXhCO0FBQ0EsVUFBSUQsY0FBYyxLQUFLQSxXQUF2QjtBQUNBLFVBQUlxRixLQUFLLEtBQUtsRixhQUFkO0FBQ0EsVUFBSW1GLE9BQU8sQ0FBQ3RGLGNBQWMsS0FBS0ksV0FBbkIsR0FBaUMsS0FBS0MsWUFBdkMsSUFBdUQsS0FBS1AsSUFBdkU7QUFDQSxVQUFJdUMsTUFBTVQsS0FBS0MsTUFBTCxLQUFnQixDQUFoQixHQUFvQixDQUFwQixHQUF3Qk8sS0FBS0MsR0FBTCxDQUFTa0QsS0FBVCxDQUFlLElBQWYsRUFBcUIzRCxJQUFyQixJQUE2QixDQUEvRDtBQUNBLFVBQUk2QixPQUFPcEIsT0FBTyxDQUFQLEdBQVcsQ0FBWCxHQUFlLENBQUNwQyxlQUFlLEtBQUtDLFVBQXBCLEdBQWlDbUYsRUFBbEMsSUFBd0NoRCxHQUFsRTtBQUNBVCxXQUFLZ0MsR0FBTCxDQUFTLFVBQVVmLElBQVYsRUFBZ0JyQyxLQUFoQixFQUF1QjtBQUM5QixZQUFJZ0YsT0FBTzNDLE9BQU9ZLElBQWxCO0FBQ0ExRCxZQUFJZ0UsU0FBSjtBQUNBaEUsWUFBSTRFLFlBQUosQ0FBaUJXLElBQWpCO0FBQ0F2RixZQUFJaUUsTUFBSixDQUFXeEQsUUFBUThFLElBQVIsR0FBZSxDQUExQixFQUE2QnJGLGVBQWVvRixFQUE1QztBQUNBdEYsWUFBSW1FLE1BQUosQ0FBVzFELFFBQVE4RSxJQUFSLEdBQWUsQ0FBMUIsRUFBNkJyRixlQUFlb0YsRUFBZixHQUFvQkcsSUFBakQ7QUFDQXpGLFlBQUk4RSxjQUFKLENBQW1CckIsT0FBT0gsS0FBUCxDQUFhN0MsS0FBYixDQUFuQjtBQUNBVCxZQUFJK0UsTUFBSjtBQUNELE9BUkQ7QUFTQSxVQUFJdEIsT0FBT2lDLFFBQVgsRUFBcUI7QUFDbkJqQyxlQUFPaUMsUUFBUCxDQUFnQixDQUFDLElBQUlMLElBQUosRUFBRCxHQUFjRCxTQUE5QjtBQUNEO0FBQ0QsVUFBSTNCLE9BQU9rQyxPQUFYLEVBQW9CO0FBQ2xCM0YsWUFBSTBFLFlBQUosQ0FBaUIsS0FBSzlELFFBQXRCO0FBQ0FaLFlBQUk0RixRQUFKLENBQWFwRyxPQUFPcUcsUUFBUCxDQUFnQnZELEdBQWhCLENBQWIsRUFBbUMsS0FBS2pDLFdBQUwsR0FBbUIsQ0FBdEQsRUFBeUQsS0FBS0YsVUFBTCxHQUFrQixFQUEzRTtBQUNEO0FBQ0YsS0E3T0k7QUE4T0wyRixVQUFNLGdCQUFZO0FBQ2hCLFVBQUkzRSxPQUFPLElBQVg7QUFDQSxVQUFJbkIsTUFBTSxLQUFLQSxHQUFmO0FBQ0EsVUFBSU8sVUFBVSxLQUFLQSxPQUFuQjtBQUNBLFVBQUksQ0FBQ0EsT0FBTCxFQUFjO0FBQ1p3RixnQkFBUUMsR0FBUixDQUFZLDJCQUFaO0FBQ0E7QUFDRDtBQUNELFVBQUlwRSxRQUFRckIsUUFBUXFCLEtBQXBCO0FBQ0EsVUFBSXdELFlBQVksQ0FBQyxJQUFJQyxJQUFKLEVBQWpCO0FBQ0EsV0FBSzNGLElBQUwsQ0FBVU0sR0FBVixFQUFlTyxPQUFmO0FBQ0FBLGNBQVEwQixLQUFSLENBQWM0QixHQUFkLENBQWtCLFVBQVVKLE1BQVYsRUFBa0JoRCxLQUFsQixFQUF5QjtBQUN6Q2dELGVBQU83QixLQUFQLEdBQWVBLEtBQWY7QUFDQVQsYUFBS3NDLE9BQU93QyxJQUFaLEVBQWtCeEMsTUFBbEI7QUFDRCxPQUhEO0FBSUEsV0FBSzNDLE9BQUwsQ0FBYW9GLFNBQWI7QUFDQWxHLFVBQUk4RixJQUFKO0FBQ0F2RixjQUFRNEYsUUFBUixJQUFvQjVGLFFBQVE0RixRQUFSLENBQWlCLENBQUMsSUFBSWQsSUFBSixFQUFELEdBQWNELFNBQS9CLENBQXBCO0FBQ0Q7QUFoUUksR0FBUDtBQWtRRCxDQW5RRCIsImZpbGUiOiJ0aW1lLXNoYXJpbmcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgQ2hlbkNoYW8gb24gMjAxNi8xMi8zMC5cbiAqL1xuXG52YXIgY29tbW9uID0gcmVxdWlyZSgnLi9jb21tb24nKVxudmFyIGF4aXMgPSByZXF1aXJlKCcuL2F4aXMtdCcpKClcblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoY2FudmFzSWQpIHtcbiAgcmV0dXJuIHtcbiAgICBuYW1lOiAnJyxcbiAgICB1bml0OiAyNDAsXG4gICAgY2FudmFzSWQ6IGNhbnZhc0lkLFxuICAgIGN0eDogbnVsbCxcbiAgICBjYW52YXNXaWR0aDogMCxcbiAgICBjYW52YXNIZWlnaHQ6IDAsXG4gICAgcGFkZGluZ1RvcDogMCxcbiAgICBwYWRkaW5nQm90dG9tOiAwLFxuICAgIHBhZGRpbmdMZWZ0OiAwLFxuICAgIHBhZGRpbmdSaWdodDogMCxcbiAgICBvcHRpb25zOiBudWxsLFxuICAgIGRhdGFTdG9yZTogbnVsbCxcbiAgICBpbmRleDogMCxcbiAgICBiYXNlOiAwLFxuICAgIG1heEFiczogMCxcbiAgICB0eHRDb2xvcjogJ3doaXRlJyxcbiAgICBpc0Nsb3NlZDogZmFsc2UsXG4gICAgYXhpc09iajogbnVsbCxcbiAgICBpbml0OiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgdGhpcy5jdHggPSB3eC5jcmVhdGVDYW52YXNDb250ZXh0KHRoaXMuY2FudmFzSWQpXG4gICAgICB0aGlzLmluaXRDb25maWcob3B0aW9ucylcbiAgICAgIHJldHVybiB0aGlzXG4gICAgfSxcblxuICAgIGluaXRDb25maWc6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICB2YXIgdGhhdCA9IHRoaXNcbiAgICAgIHZhciBheGlzID0gb3B0aW9ucy5heGlzXG4gICAgICB0aGlzLm5hbWUgPSBvcHRpb25zLm5hbWVcbiAgICAgIGlmIChvcHRpb25zLm5hbWUgPT0gJ3RpbWUtc2hhcmluZy01ZGF5Jykge1xuICAgICAgICB0aGlzLnVuaXQgPSB0aGlzLnVuaXQgKiA1XG4gICAgICB9XG4gICAgICB2YXIgdyA9IG9wdGlvbnMud2lkdGhcbiAgICAgIHZhciBoID0gb3B0aW9ucy5oZWlnaHRcbiAgICAgIGlmICh3ID09PSAnYXV0bycpIHtcbiAgICAgICAgd3guZ2V0U3lzdGVtSW5mbyh7XG4gICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgdyA9IHRoYXQuY2FudmFzV2lkdGggPSByZXN1bHQud2luZG93V2lkdGhcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICBpZiAoaCA9PT0gJ2F1dG8nKSB7XG4gICAgICAgIGggPSAyMjVcbiAgICAgIH1cbiAgICAgIHRoaXMuY2FudmFzV2lkdGggPSB3XG4gICAgICB0aGlzLmNhbnZhc0hlaWdodCA9IGhcbiAgICAgIG9wdGlvbnMueEF4aXMuZGF0YS5sZW5ndGggPSB0aGlzLnVuaXRcbiAgICAgIHRoaXMucGFkZGluZ1RvcCA9IGF4aXMucGFkZGluZ1RvcFxuICAgICAgdGhpcy5wYWRkaW5nQm90dG9tID0gYXhpcy5wYWRkaW5nQm90dG9tXG4gICAgICB0aGlzLnBhZGRpbmdMZWZ0ID0gYXhpcy5wYWRkaW5nTGVmdFxuICAgICAgdGhpcy5wYWRkaW5nUmlnaHQgPSBheGlzLnBhZGRpbmdSaWdodFxuICAgICAgdGhpcy5kYXRhU3RvcmUgPSBvcHRpb25zXG4gICAgfSxcblxuICAgIG1ldGFEYXRhMTogZnVuY3Rpb24gKG9yaWdpbiwgb3B0aW9ucykge1xuICAgICAgdmFyIGRhdGFTdG9yZSA9IG9wdGlvbnNcbiAgICAgIHZhciBkYXRhID0gb3JpZ2luLmRhdGFcbiAgICAgIHZhciB4QXhpcyA9IGRhdGFTdG9yZS54QXhpc1xuXG4gICAgICB2YXIgeUF4aXMgPSBkYXRhU3RvcmUueUF4aXNcbiAgICAgIHZhciBiYXNlID0gb3JpZ2luLmluZm8ueWMgKiAxXG4gICAgICB2YXIgaCA9IG9yaWdpbi5pbmZvLmggKiAxIHx8IGJhc2VcbiAgICAgIHZhciBsID0gb3JpZ2luLmluZm8ubCAqIDEgfHwgYmFzZVxuICAgICAgdmFyIG1heEFicyA9IGggPyBNYXRoLm1heChNYXRoLmFicyhoIC0gYmFzZSksIE1hdGguYWJzKGwgLSBiYXNlKSkgOiB0aGlzLm1heEFic1xuXG4gICAgICAvLyDlgZznm5hcbiAgICAgIGlmIChvcmlnaW4uaW5mby5jID09ICctJykge1xuICAgICAgICB0aGlzLmlzQ2xvc2VkID0gdHJ1ZVxuICAgICAgICB5QXhpc1sxXS5pc0F2ZXJhZ2VMaW5lID0gdHJ1ZVxuICAgICAgfVxuXG4gICAgICB2YXIgZGF0YTAgPSB5QXhpc1sxXS5kYXRhXG4gICAgICB5QXhpc1swXS5iYXNlID0gYmFzZSAvLyDmmKjmlLZcbiAgICAgIHZhciBkYXRhMSA9IHlBeGlzWzBdLmRhdGFcbiAgICAgIC8vIGlmKGRhdGEubGVuZ3RoIDwgMTUpe1xuICAgICAgLy8gICAgIGRhdGEgPSBbXVxuICAgICAgLy8gfWVsc2UgaWYoZGF0YS5sZW5ndGggPCAxNSArIHRoaXMudW5pdCl7XG4gICAgICAvLyAgICAgZGF0YSA9IGRhdGEuc2xpY2UoMTUpOyAvL+WOu+aOieWJjTE15p2h5pWw5o2uXG4gICAgICAvLyB9ZWxzZXtcbiAgICAgIC8vICAgICBkYXRhID0gZGF0YS5zbGljZShkYXRhLmxlbmd0aCAtIHRoaXMudW5pdCAtIDEpOyAvL+WOu+aOieWJjTE15p2h5pWw5o2uXG4gICAgICAvLyB9XG4gICAgICB2YXIgZGF5NSA9IFtdXG4gICAgICBkYXRhLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0sIGluZGV4KSB7XG4gICAgICAgIHZhciBkID0gaXRlbS5zcGxpdCgnLCcpXG4gICAgICAgIHhBeGlzLmRhdGFbaW5kZXhdID0gZFswXSAvLyDml7bpl7RcbiAgICAgICAgZGF0YTBbaW5kZXhdID0gZFszXSAvLyDlnYfku7dcbiAgICAgICAgZGF0YTFbaW5kZXhdID0gZFsxXSAvLyDnjrDku7dcbiAgICAgICAgbWF4QWJzID0gTWF0aC5tYXgoTWF0aC5hYnMoZFsxXSAtIGJhc2UpLCBNYXRoLmFicyhkWzNdIC0gYmFzZSksIG1heEFicylcbiAgICAgICAgLy8geUF4aXNbMF0ubWF4QWJzID0geUF4aXNbMV0ubWF4QWJzID0gbWF4QWJzO1xuICAgICAgfSlcbiAgICAgIHRoaXMuYmFzZSA9IGJhc2VcbiAgICAgIHRoaXMubWF4QWJzID0geUF4aXNbMF0ubWF4QWJzID0geUF4aXNbMV0ubWF4QWJzID0gbWF4QWJzXG4gICAgICBkYXRhU3RvcmUuYXhpcy5kYXk1ID0gY29tbW9uLmRpc1JlcEFycihkYXk1KVxuICAgICAgdGhpcy5zZXRPcHRpb25zKGRhdGFTdG9yZSlcbiAgICB9LFxuXG4gICAgbWV0YURhdGEyOiBmdW5jdGlvbiAob3JpZ2luLCBvcHRpb25zKSB7XG4gICAgICB2YXIgZGF0YVN0b3JlID0gb3B0aW9uc1xuICAgICAgdmFyIGRhdGEgPSBvcmlnaW4uZGF0YVxuXG4gICAgICAvLyDlgZznm5hcbiAgICAgIGlmIChvcmlnaW4uaW5mby5jID09ICctJykge1xuICAgICAgICB0aGlzLmlzQ2xvc2VkID0gdHJ1ZVxuICAgICAgfVxuXG4gICAgICB2YXIgeEF4aXMgPSBkYXRhU3RvcmUueEF4aXNcbiAgICAgIHZhciB5QXhpcyA9IGRhdGFTdG9yZS55QXhpc1xuICAgICAgdmFyIGRhdGEwID0geUF4aXNbMF0uZGF0YVxuICAgICAgdmFyIGRkID0gW11cbiAgICAgIHZhciBjb2xvcjAgPSB5QXhpc1swXS5jb2xvclxuICAgICAgLy8gICAgICAgaWYgKGRhdGEubGVuZ3RoIDwgMTUpIHtcbiAgICAgIC8vICAgZGF0YSA9IFtdXG4gICAgICAvLyB9IGVsc2UgaWYgKGRhdGEubGVuZ3RoIDwgMTUgKyB0aGlzLnVuaXQpIHtcbiAgICAgIC8vICAgZGF0YSA9IGRhdGEuc2xpY2UoMTUpIC8v5Y675o6J5YmNMTXmnaHmlbDmja5cbiAgICAgIC8vICAgICAgIH0gZWxzZXtcbiAgICAgIC8vICAgZGF0YSA9IGRhdGEuc2xpY2UoZGF0YS5sZW5ndGggLSB0aGlzLnVuaXQgLSAxKSAvL+WOu+aOieWJjTE15p2h5pWw5o2uXG4gICAgICAvLyAgICAgICB9XG4gICAgICB2YXIgZGF5NSA9IFtdXG4gICAgICBkYXRhLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0sIGluZGV4KSB7XG4gICAgICAgIHZhciBkID0gaXRlbS5zcGxpdCgnLCcpXG4gICAgICAgIHhBeGlzLmRhdGFbaW5kZXhdID0gZFswXSAvLyDml7bpl7RcbiAgICAgICAgZGF0YTBbaW5kZXhdID0gZFsyXSAvLyDmiJDkuqTph49cbiAgICAgICAgZGRbaW5kZXhdID0gZFsxXSAvLyDnjrDku7dcbiAgICAgICAgY29sb3IwW2luZGV4XSA9IGRkW2luZGV4XSAtIGRkW2luZGV4IC0gMV0gPCAwID8gJyM0Y2RhNjQnIDogJyNmZjJmMmYnXG4gICAgICAgIGRheTUucHVzaChkWzBdLnNwbGl0KCcgJylbMF0pXG4gICAgICB9KVxuICAgICAgZGF0YVN0b3JlLmF4aXMuZGF5NSA9IGNvbW1vbi5kaXNSZXBBcnIoZGF5NSlcbiAgICAgIHRoaXMuc2V0T3B0aW9ucyhkYXRhU3RvcmUpXG4gICAgfSxcblxuICAgIHNldE9wdGlvbnM6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zXG4gICAgfSxcblxuICAgIGF4aXM6IGZ1bmN0aW9uIChjdHgsIG9wdGlvbnMpIHtcbiAgICAgIHRoaXMuYXhpc09iaiA9IGF4aXMuaW5pdChjdHgsIG9wdGlvbnMpXG4gICAgfSxcblxuICAgIGxpbmU6IGZ1bmN0aW9uIChvcHRpb24pIHtcbiAgICAgIGlmICh0aGlzLmlzQ2xvc2VkICYmICFvcHRpb24uaXNBdmVyYWdlTGluZSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIHZhciB0aGF0ID0gdGhpc1xuICAgICAgdmFyIGN0eCA9IHRoaXMuY3R4XG4gICAgICB2YXIgY2FudmFzSGVpZ2h0ID0gdGhpcy5jYW52YXNIZWlnaHRcbiAgICAgIHZhciBjYW52YXNXaWR0aCA9IHRoaXMuY2FudmFzV2lkdGhcbiAgICAgIHZhciBzdGVwID0gKGNhbnZhc1dpZHRoIC0gdGhpcy5wYWRkaW5nTGVmdCAtIHRoaXMucGFkZGluZ1JpZ2h0KSAvIHRoaXMudW5pdFxuICAgICAgdmFyIGFyZWFIID0gY2FudmFzSGVpZ2h0IC0gdGhpcy5wYWRkaW5nVG9wIC0gdGhpcy5wYWRkaW5nQm90dG9tXG4gICAgICB2YXIgbWF4ID0gdGhpcy5iYXNlICsgdGhpcy5tYXhBYnNcbiAgICAgIHZhciBtaW4gPSB0aGlzLmJhc2UgLSB0aGlzLm1heEFic1xuICAgICAgdmFyIGRhdGEgPSBbXVxuICAgICAgb3B0aW9uLnhBeGlzLmRhdGEubWFwKGZ1bmN0aW9uIChpdGVtLCBpbmRleCkge1xuICAgICAgICB2YXIgZCA9IG9wdGlvbi5kYXRhW2luZGV4XVxuICAgICAgICB2YXIgdmFsdWUgPSBhcmVhSCAtIGFyZWFIICogKGQgLSBtaW4pIC8gKG1heCAtIG1pbilcbiAgICAgICAgZGF0YS5wdXNoKFtpbmRleCAqIHN0ZXAgLSB0aGF0LnBhZGRpbmdMZWZ0LCB2YWx1ZSAtIHRoYXQucGFkZGluZ0JvdHRvbV0pXG4gICAgICB9KVxuXG4gICAgICBpZiAob3B0aW9uLmlzQXZlcmFnZUxpbmUpIHtcbiAgICAgICAgY3R4LnRyYW5zbGF0ZSgwLCBjYW52YXNIZWlnaHQgLyAyKVxuICAgICAgfVxuXG4gICAgICAvLyDloavlhYVcbiAgICAgIGN0eC5iZWdpblBhdGgoKVxuICAgICAgY3R4Lm1vdmVUbyh0aGlzLnBhZGRpbmdMZWZ0LCB0aGlzLmNhbnZhc0hlaWdodCAtIHRoaXMucGFkZGluZ0JvdHRvbSlcbiAgICAgIHZhciBsYXN0WCA9IDBcbiAgICAgIGRhdGEubWFwKGZ1bmN0aW9uIChpdGVtLCBpbmRleCkge1xuICAgICAgICBjdHgubGluZVRvKGl0ZW1bMF0sIGl0ZW1bMV0pXG4gICAgICAgIGxhc3RYID0gaXRlbVswXVxuICAgICAgfSlcbiAgICAgIGN0eC5saW5lVG8obGFzdFgsIHRoaXMuY2FudmFzSGVpZ2h0IC0gdGhpcy5wYWRkaW5nQm90dG9tKVxuICAgICAgY3R4LmNsb3NlUGF0aCgpXG4gICAgICBpZiAodHlwZW9mIG9wdGlvbi5iYWNrZ3JvdW5kID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHZhciBjb2xvclN0b3AgPSBvcHRpb24uYmFja2dyb3VuZCgpXG4gICAgICAgIHZhciBncmQgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoMCwgMCwgMCwgY2FudmFzSGVpZ2h0KVxuICAgICAgICBncmQuYWRkQ29sb3JTdG9wKDAsIGNvbG9yU3RvcFswXSlcbiAgICAgICAgZ3JkLmFkZENvbG9yU3RvcCgxLCBjb2xvclN0b3BbMV0pXG4gICAgICAgIGN0eC5zZXRGaWxsU3R5bGUoZ3JkKVxuICAgICAgICBjdHguZmlsbCgpXG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIG9wdGlvbi5iYWNrZ3JvdW5kID09PSAnc3RyaW5nJykge1xuICAgICAgICBjdHguc2V0RmlsbFN0eWxlKG9wdGlvbi5iYWNrZ3JvdW5kKVxuICAgICAgICBjdHguZmlsbCgpXG4gICAgICB9XG4gICAgICBjdHguc2V0TGluZVdpZHRoKDEpXG4gICAgICBjdHguc2V0TGluZUNhcCgnc3F1YXJlJylcbiAgICAgIGN0eC5zZXRTdHJva2VTdHlsZSgncmdiYSgwLDAsMCwwKScpXG4gICAgICBjdHguc3Ryb2tlKClcblxuICAgICAgLy8g5Z2H57q/XG4gICAgICBjdHguYmVnaW5QYXRoKClcbiAgICAgIGRhdGEubWFwKGZ1bmN0aW9uIChpdGVtLCBpbmRleCkge1xuICAgICAgICBjdHhbaW5kZXggPT09IDAgPyAnbW92ZVRvJyA6ICdsaW5lVG8nXShpdGVtWzBdLCBpdGVtWzFdKVxuICAgICAgfSlcbiAgICAgIGN0eC5zZXRMaW5lV2lkdGgoMSlcbiAgICAgIGN0eC5zZXRMaW5lQ2FwKCdzcXVhcmUnKVxuICAgICAgY3R4LnNldFN0cm9rZVN0eWxlKG9wdGlvbi5saW5lQ29sb3IpXG4gICAgICBjdHguc3Ryb2tlKClcblxuICAgICAgaWYgKG9wdGlvbi5pc0F2ZXJhZ2VMaW5lKSB7XG4gICAgICAgIGN0eC50cmFuc2xhdGUoMCwgLWNhbnZhc0hlaWdodCAvIDIpXG4gICAgICB9XG4gICAgfSxcbiAgICBiZXppZXJMaW5lOiBmdW5jdGlvbiAob3B0aW9uKSB7XG4gICAgICBpZiAodGhpcy5pc0Nsb3NlZCkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNvbW1vbi5iZXppZXJMaW5lLmNhbGwodGhpcywgb3B0aW9uKVxuICAgIH0sXG4gICAgYmFyOiBmdW5jdGlvbiAob3B0aW9uKSB7XG4gICAgICBpZiAodGhpcy5pc0Nsb3NlZCkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIHZhciBzdGFydFRpbWUgPSArbmV3IERhdGUoKVxuICAgICAgdmFyIGRhdGEgPSBvcHRpb24uZGF0YVxuICAgICAgdmFyIGN0eCA9IHRoaXMuY3R4XG4gICAgICB2YXIgY2FudmFzSGVpZ2h0ID0gdGhpcy5jYW52YXNIZWlnaHRcbiAgICAgIHZhciBjYW52YXNXaWR0aCA9IHRoaXMuY2FudmFzV2lkdGhcbiAgICAgIHZhciBwYiA9IHRoaXMucGFkZGluZ0JvdHRvbVxuICAgICAgdmFyIGJhclcgPSAoY2FudmFzV2lkdGggLSB0aGlzLnBhZGRpbmdMZWZ0IC0gdGhpcy5wYWRkaW5nUmlnaHQpIC8gdGhpcy51bml0XG4gICAgICB2YXIgbWF4ID0gZGF0YS5sZW5ndGggPT09IDAgPyAwIDogTWF0aC5tYXguYXBwbHkobnVsbCwgZGF0YSkgKiAxXG4gICAgICB2YXIgc3RlcCA9IG1heCA9PSAwID8gMCA6IChjYW52YXNIZWlnaHQgLSB0aGlzLnBhZGRpbmdUb3AgLSBwYikgLyBtYXhcbiAgICAgIGRhdGEubWFwKGZ1bmN0aW9uIChpdGVtLCBpbmRleCkge1xuICAgICAgICB2YXIgYmFySCA9IGl0ZW0gKiBzdGVwXG4gICAgICAgIGN0eC5iZWdpblBhdGgoKVxuICAgICAgICBjdHguc2V0TGluZVdpZHRoKGJhclcpXG4gICAgICAgIGN0eC5tb3ZlVG8oaW5kZXggKiBiYXJXICsgMSwgY2FudmFzSGVpZ2h0IC0gcGIpXG4gICAgICAgIGN0eC5saW5lVG8oaW5kZXggKiBiYXJXICsgMSwgY2FudmFzSGVpZ2h0IC0gcGIgLSBiYXJIKVxuICAgICAgICBjdHguc2V0U3Ryb2tlU3R5bGUob3B0aW9uLmNvbG9yW2luZGV4XSlcbiAgICAgICAgY3R4LnN0cm9rZSgpXG4gICAgICB9KVxuICAgICAgaWYgKG9wdGlvbi5jb21wbGV0ZSkge1xuICAgICAgICBvcHRpb24uY29tcGxldGUoK25ldyBEYXRlKCkgLSBzdGFydFRpbWUpXG4gICAgICB9XG4gICAgICBpZiAob3B0aW9uLnNob3dNYXgpIHtcbiAgICAgICAgY3R4LnNldEZpbGxTdHlsZSh0aGlzLnR4dENvbG9yKVxuICAgICAgICBjdHguZmlsbFRleHQoY29tbW9uLm1ldGFVbml0KG1heCksIHRoaXMucGFkZGluZ0xlZnQgKyAyLCB0aGlzLnBhZGRpbmdUb3AgKyAxMilcbiAgICAgIH1cbiAgICB9LFxuICAgIGRyYXc6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHZhciB0aGF0ID0gdGhpc1xuICAgICAgdmFyIGN0eCA9IHRoaXMuY3R4XG4gICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uc1xuICAgICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdXYXJuOiBObyBzZXR0aW5nIG9wdGlvbnMhJylcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICB2YXIgeEF4aXMgPSBvcHRpb25zLnhBeGlzXG4gICAgICB2YXIgc3RhcnRUaW1lID0gK25ldyBEYXRlKClcbiAgICAgIHRoaXMuYXhpcyhjdHgsIG9wdGlvbnMpXG4gICAgICBvcHRpb25zLnlBeGlzLm1hcChmdW5jdGlvbiAob3B0aW9uLCBpbmRleCkge1xuICAgICAgICBvcHRpb24ueEF4aXMgPSB4QXhpc1xuICAgICAgICB0aGF0W29wdGlvbi50eXBlXShvcHRpb24pXG4gICAgICB9KVxuICAgICAgdGhpcy5heGlzT2JqLmRyYXdZVW5pdCgpXG4gICAgICBjdHguZHJhdygpXG4gICAgICBvcHRpb25zLmNhbGxiYWNrICYmIG9wdGlvbnMuY2FsbGJhY2soK25ldyBEYXRlKCkgLSBzdGFydFRpbWUpXG4gICAgfVxuICB9XG59XG4iXX0=